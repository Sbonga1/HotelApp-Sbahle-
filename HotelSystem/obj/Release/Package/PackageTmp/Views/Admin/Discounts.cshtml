@model IEnumerable<HotelSystem.Models.Discount>

@{
    ViewBag.Title = "Manage Discounts";
    Layout = "~/Views/Shared/_Layout.cshtml";

    var productList = ViewBag.Products as List<HotelSystem.Models.Product>;
    var roomList = ViewBag.Rooms as List<HotelSystem.Models.Apartment>;
}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

<section class="discounts-section py-5">
    <div class="container py-md-5">
        <h2 class="mb-2 text-center fw-bold text-danger">
            <i class="fa-solid fa-tags"></i> Current Discounts
        </h2>

        <p class="text-center mb-4">
            <span class="badge bg-danger-subtle border border-danger text-dark px-3 py-2 shadow-sm">
                🎁 Applies automatically on the customer’s next eligible purchase
            </span>
        </p>

        @if (!Model.Any())
        {
            <div class="alert alert-danger text-center fw-bold">
                <i class="fa fa-exclamation-circle"></i> No discounts available.
            </div>
        }
        else
        {
            <div class="table-responsive" style="width:fit-content">
                <table class="table table-bordered table-hover text-center align-middle shadow-sm">
                    <thead style="background-color: #111; color: white;">
                        <tr>
                            <th>Name</th>
                            <th>Type</th>
                            <th>Targeted Items</th>
                            <th>Percentage</th>
                            <th>Min Spend</th>
                            <th>Start</th>
                            <th>End</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var discount in Model)
                        {
                            <tr>
                                <td class="fw-semibold text-dark">@discount.Name</td>
                                <td><span class="badge bg-dark">@discount.ApplicableItemType</span></td>
                                <td class="text-start">
                                    <ul class="list-unstyled mb-1">
                                        @if (discount.ApplicableItemType == "Product")
                                        {
                                            var productIds = discount.ApplicableItemIds?.Split(',') ?? new string[] { };
                                            foreach (var id in productIds)
                                            {
                                                var prod = productList?.FirstOrDefault(p => p.Id.ToString() == id);
                                                if (prod != null)
                                                {
                                                    <li><i class="fa fa-utensils text-danger me-1"></i> @prod.Name (R @prod.Price)</li>
                                                }
                                            }
                                        }
                                        else if (discount.ApplicableItemType == "Room")
                                        {
                                            var roomIds = discount.ApplicableItemIds?.Split(',') ?? new string[] { };
                                            foreach (var id in roomIds)
                                            {
                                                var room = roomList?.FirstOrDefault(r => r.ID.ToString() == id);
                                                if (room != null)
                                                {
                                                    <li><i class="fa fa-bed text-danger me-1"></i> Room @room.Room (@room.RoomType)</li>
                                                }
                                            }
                                        }
                                    </ul>
                                </td>
                                <td><span class="badge bg-danger text-white">@discount.Percentage %</span></td>
                                <td>R @discount.MinimumSpend.ToString("F2")</td>
                                <td>@discount.StartDate.ToString("dd MMM yyyy")</td>
                                <td>@discount.EndDate.ToString("dd MMM yyyy")</td>
                                <td>
                                    @if (discount.IsActive)
                                    {
                                        <span class="badge bg-success px-3 py-2">Active</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-secondary px-3 py-2">Inactive</span>
                                    }
                                </td>
                                <td>
                                    <a href="@Url.Action("EditDiscount", "Admin", new { id = discount.Id })"
                                       class="btn btn-sm btn-outline-dark mb-1 w-100">
                                        <i class="fa fa-edit text-danger"></i> Edit
                                    </a>
                                    <a href="@Url.Action("DeleteDiscount", "Admin", new { id = discount.Id })"
                                       class="btn btn-sm btn-outline-danger w-100"
                                       onclick="return confirm('Are you sure you want to delete this discount?');">
                                        <i class="fa fa-trash"></i> Delete
                                    </a>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>
</section>

<style>
    .discounts-section h2 {
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .badge {
        font-size: 0.85rem;
        padding: 6px 10px;
        border-radius: 6px;
    }

    .table-hover tbody tr:hover {
        background-color: #f1f1f1;
    }

    .text-start li {
        margin-bottom: 4px;
    }

    .btn-sm i {
        margin-right: 4px;
    }

    .btn-outline-dark:hover {
        background-color: #111;
        color: white;
    }

    .table td,
    .table th {
        vertical-align: middle;
    }

    .bg-danger-subtle {
        background-color: #f8d7da;
    }
</style>
